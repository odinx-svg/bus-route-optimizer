---
phase: 02-metrics-charts
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - frontend/src/components/metrics/MetricsSidebar.tsx
  - frontend/src/components/metrics/index.ts
autonomous: false

must_haves:
  truths:
    - "MetricsSidebar displays 4+ KPIs (buses, routes, efficiency, deadhead)"
    - "Each metric card has glass morphism styling"
    - "Trend arrows show green for positive, red for negative"
    - "Bar chart renders routes by bus"
    - "Chart has dark theme with light text on transparent background"
  artifacts:
    - path: "frontend/src/components/metrics/MetricsSidebar.tsx"
      provides: "Complete metrics sidebar component"
      exports: ["MetricsSidebar"]
    - path: "frontend/src/components/metrics/index.ts"
      provides: "Barrel export for metrics components"
      exports: ["MetricsSidebar", "MetricCard", "RoutesChart", "AnimatedNumber"]
  key_links:
    - from: "frontend/src/components/metrics/MetricsSidebar.tsx"
      to: "frontend/src/hooks/useMetrics.ts"
      via: "import"
      pattern: "import.*useMetrics.*from.*hooks"
    - from: "frontend/src/components/metrics/MetricsSidebar.tsx"
      to: "frontend/src/components/metrics/MetricCard.tsx"
      via: "import"
      pattern: "import.*MetricCard"
    - from: "frontend/src/components/metrics/MetricsSidebar.tsx"
      to: "frontend/src/components/metrics/RoutesChart.tsx"
      via: "import"
      pattern: "import.*RoutesChart"
---

<objective>
Create MetricsSidebar component that combines all Phase 2 metrics components, add barrel export, and verify visual appearance.

Purpose: This is the deliverable for Phase 2 - a complete metrics sidebar that can be integrated into the main app layout in Phase 4.

Output: MetricsSidebar.tsx ready for integration, barrel export at components/metrics/index.ts, visual verification of all success criteria.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-metrics-charts/02-RESEARCH.md

# Phase 2-01 artifacts
@frontend/src/types/metrics.ts
@frontend/src/hooks/useMetrics.ts

# Phase 2-02 artifacts
@frontend/src/components/metrics/AnimatedNumber.tsx
@frontend/src/components/metrics/MetricCard.tsx
@frontend/src/components/metrics/RoutesChart.tsx

# Phase 1 components
@frontend/src/components/ui/GlassCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MetricsSidebar component</name>
  <files>frontend/src/components/metrics/MetricsSidebar.tsx</files>
  <action>
    Create `frontend/src/components/metrics/MetricsSidebar.tsx`:

    ```typescript
    import { GlassCard } from '../ui';
    import { MetricCard } from './MetricCard';
    import { RoutesChart } from './RoutesChart';
    import { useMetrics } from '../../hooks/useMetrics';
    import type { BusSchedule, ChartDataPoint, TrendDirection } from '../../types/metrics';

    interface MetricsSidebarProps {
      /** Schedule data from optimization result */
      schedule: BusSchedule[] | null;
    }

    /**
     * Determine trend direction based on metric value and thresholds.
     * Higher efficiency is good (up), lower deadhead is good (up).
     */
    function getEfficiencyTrend(efficiency: number): TrendDirection {
      if (efficiency >= 80) return 'up';
      if (efficiency < 60) return 'down';
      return 'neutral';
    }

    function getDeadheadTrend(deadhead: number, totalRoutes: number): TrendDirection {
      // Average deadhead per route - lower is better
      const avgDeadhead = totalRoutes > 0 ? deadhead / totalRoutes : 0;
      if (avgDeadhead <= 10) return 'up';
      if (avgDeadhead > 20) return 'down';
      return 'neutral';
    }

    /**
     * Left sidebar displaying fleet KPIs and routes chart.
     *
     * Displays:
     * - Total buses in service
     * - Total routes assigned
     * - Fleet efficiency percentage
     * - Total deadhead time
     * - Routes by bus bar chart
     */
    export function MetricsSidebar({ schedule }: MetricsSidebarProps) {
      const metrics = useMetrics(schedule);

      // Prepare chart data: routes count per bus
      const chartData: ChartDataPoint[] = schedule?.map((bus) => ({
        name: bus.bus_id,
        routes: bus.items.length,
      })) || [];

      // Empty state when no data
      if (!metrics) {
        return (
          <div className="w-72 bg-dark-bg/50 border-r border-glass-border flex flex-col p-4">
            <h2 className="text-lg font-bold text-white mb-4">Fleet Metrics</h2>
            <div className="flex-1 flex items-center justify-center">
              <p className="text-slate-500 text-sm text-center">
                Upload a schedule file and run optimization to see metrics
              </p>
            </div>
          </div>
        );
      }

      const efficiencyTrend = getEfficiencyTrend(metrics.efficiency);
      const deadheadTrend = getDeadheadTrend(metrics.totalDeadhead, metrics.totalRoutes);

      return (
        <div className="w-72 bg-dark-bg/50 border-r border-glass-border flex flex-col p-4 space-y-4">
          {/* Header */}
          <h2 className="text-lg font-bold text-white flex items-center gap-2">
            <span className="w-1.5 h-5 bg-neon-green rounded-full shadow-neon-green"></span>
            Fleet Metrics
          </h2>

          {/* KPI Grid - 2x2 */}
          <div className="grid grid-cols-2 gap-3">
            <MetricCard
              label="Total Buses"
              value={metrics.totalBuses}
              trend="neutral"
            />
            <MetricCard
              label="Total Routes"
              value={metrics.totalRoutes}
              trend="neutral"
            />
            <MetricCard
              label="Efficiency"
              value={metrics.efficiency}
              unit="%"
              decimals={1}
              trend={efficiencyTrend}
              trendLabel={efficiencyTrend === 'up' ? 'Good' : efficiencyTrend === 'down' ? 'Low' : undefined}
            />
            <MetricCard
              label="Deadhead"
              value={metrics.totalDeadhead}
              unit="min"
              trend={deadheadTrend}
              trendLabel={deadheadTrend === 'up' ? 'Low' : deadheadTrend === 'down' ? 'High' : undefined}
            />
          </div>

          {/* Routes Chart */}
          <GlassCard padding="sm" className="flex flex-col">
            <h3 className="text-sm font-medium text-slate-400 mb-3">Routes by Bus</h3>
            <RoutesChart data={chartData} height={180} />
          </GlassCard>
        </div>
      );
    }
    ```

    Key points:
    - 4 KPIs: Total Buses, Total Routes, Efficiency, Deadhead (matches MET-01 through MET-04)
    - Trend logic: efficiency >= 80% is good (green), < 60% is bad (red)
    - Trend logic: low avg deadhead is good (green), high is bad (red)
    - Chart shows routes per bus (CHT-01)
    - Empty state shown when no schedule data
    - Width fixed at 72 (w-72 = 18rem = 288px) to match existing MapView sidebar
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors.
    File imports useMetrics, MetricCard, RoutesChart, GlassCard correctly.
    File exports MetricsSidebar.
  </verify>
  <done>MetricsSidebar.tsx exists with 4 KPI cards, chart, and proper dark theme styling</done>
</task>

<task type="auto">
  <name>Task 2: Create barrel export for metrics components</name>
  <files>frontend/src/components/metrics/index.ts</files>
  <action>
    Create `frontend/src/components/metrics/index.ts`:

    ```typescript
    export { AnimatedNumber } from './AnimatedNumber';
    export { MetricCard } from './MetricCard';
    export { RoutesChart } from './RoutesChart';
    export { MetricsSidebar } from './MetricsSidebar';
    ```

    This follows the same pattern as components/ui/index.ts from Phase 1.

    Usage:
    ```typescript
    import { MetricsSidebar, MetricCard } from './components/metrics';
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors.
    File exports all 4 components.
  </verify>
  <done>Barrel export exists at components/metrics/index.ts with all 4 component exports</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 2 metrics visualization system:
    - MetricsSidebar component with 4 KPIs and bar chart
    - MetricCard component with GlassCard styling and trend arrows
    - RoutesChart component with dark-themed Recharts bar chart
    - AnimatedNumber component with Framer Motion springs
    - useMetrics hook for computing metrics from schedule data
  </what-built>
  <how-to-verify>
    1. Start the development server:
       ```bash
       cd frontend && npm run dev
       ```

    2. Open browser to http://localhost:5173 (or the URL shown in terminal)

    3. To see the MetricsSidebar with real data:
       - Upload a schedule Excel file (if available)
       - Run optimization
       - The sidebar should appear with metrics

    4. Alternatively, create a quick test by temporarily adding MetricsSidebar to App.jsx with mock data:
       ```jsx
       import { MetricsSidebar } from './components/metrics';

       // Mock data for testing
       const mockSchedule = [
         { bus_id: 'B1', items: [{ route_id: 'R1', start_time: '07:00', end_time: '07:30', type: 'entry' }] },
         { bus_id: 'B2', items: [{ route_id: 'R2', start_time: '07:15', end_time: '07:45', type: 'entry' }, { route_id: 'R3', start_time: '08:00', end_time: '08:30', type: 'exit' }] },
       ];

       // Add <MetricsSidebar schedule={mockSchedule} /> somewhere visible
       ```

    5. Verify these success criteria:
       - [ ] MetricsSidebar displays 4+ KPIs (Total Buses, Total Routes, Efficiency, Deadhead)
       - [ ] Each metric card has glass morphism styling (blur background, subtle border)
       - [ ] Trend arrows show: green TrendingUp for good metrics, red TrendingDown for bad
       - [ ] Bar chart renders showing routes per bus
       - [ ] Chart has dark background with light gray text on axes
       - [ ] Numbers animate when values change (try changing mock data values)

    6. Check dark theme integration:
       - [ ] Sidebar blends with dark background
       - [ ] Text is readable (white/light gray)
       - [ ] Neon-green accent visible on header and positive trends
       - [ ] No white/light backgrounds that break the theme
  </how-to-verify>
  <resume-signal>Type "approved" if all criteria pass, or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. Files exist:
   - frontend/src/components/metrics/MetricsSidebar.tsx
   - frontend/src/components/metrics/index.ts
4. Visual verification confirms all 5 success criteria from ROADMAP.md
</verification>

<success_criteria>
Phase 2 success criteria (from ROADMAP.md):
1. MetricsSidebar component displays 4+ KPIs - VERIFIED via human checkpoint
2. Each metric card uses GlassCard styling - VERIFIED via human checkpoint
3. Trend arrows show green (up) or red (down) - VERIFIED via human checkpoint
4. Recharts bar chart renders routes data - VERIFIED via human checkpoint
5. Chart integrates with dark theme (transparent bg, light text) - VERIFIED via human checkpoint
</success_criteria>

<output>
After completion (including checkpoint approval), create `.planning/phases/02-metrics-charts/02-03-SUMMARY.md`
</output>
