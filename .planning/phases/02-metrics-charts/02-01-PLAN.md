---
phase: 02-metrics-charts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/package-lock.json
  - frontend/src/types/metrics.ts
  - frontend/src/hooks/useMetrics.ts
autonomous: true

must_haves:
  truths:
    - "Recharts library is installed and importable"
    - "TypeScript types exist for schedule data structures"
    - "Metrics can be computed from schedule array"
  artifacts:
    - path: "frontend/src/types/metrics.ts"
      provides: "ScheduleItem, BusSchedule, Metrics, ChartDataPoint types"
      exports: ["ScheduleItem", "BusSchedule", "Metrics", "ChartDataPoint"]
    - path: "frontend/src/hooks/useMetrics.ts"
      provides: "useMetrics custom hook"
      exports: ["useMetrics"]
  key_links:
    - from: "frontend/src/hooks/useMetrics.ts"
      to: "frontend/src/types/metrics.ts"
      via: "import type"
      pattern: "import.*from.*types/metrics"
---

<objective>
Install Recharts and create foundational TypeScript types and useMetrics hook for Phase 2 metrics system.

Purpose: Establish the data layer that all metric components will consume. Types ensure type safety across components, useMetrics centralizes metric calculations.

Output: Recharts available for import, types/metrics.ts with data interfaces, hooks/useMetrics.ts with memoized metric computation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-metrics-charts/02-RESEARCH.md

# Phase 1 established TypeScript config and Tailwind theme
@frontend/tsconfig.json
@frontend/src/components/MapView.jsx (has existing metrics calculation pattern lines 56-89)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts</name>
  <files>frontend/package.json, frontend/package-lock.json</files>
  <action>
    Navigate to frontend directory and install recharts:
    ```bash
    cd frontend && npm install recharts
    ```

    Recharts 3.x is the current stable version. Use named imports in future tasks to enable tree-shaking (do NOT use default import).
  </action>
  <verify>
    Run `npm ls recharts` in frontend directory - should show recharts@3.x installed.
    Run `npm run build` - should complete without errors.
  </verify>
  <done>Recharts appears in package.json dependencies, npm ls shows version 3.x</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types for metrics</name>
  <files>frontend/src/types/metrics.ts</files>
  <action>
    Create `frontend/src/types/` directory if it doesn't exist.

    Create `frontend/src/types/metrics.ts` with these interfaces:

    ```typescript
    // Schedule data structures (matches backend response)
    export interface ScheduleItem {
      route_id: string;
      start_time: string;
      end_time: string;
      type: 'entry' | 'exit';
      original_start_time?: string;
      time_shift_minutes?: number;
      deadhead_minutes?: number;
      school_name?: string;
      contract_id?: string;
    }

    export interface BusSchedule {
      bus_id: string;
      items: ScheduleItem[];
    }

    // Computed metrics
    export interface Metrics {
      totalBuses: number;
      totalRoutes: number;
      avgRoutesPerBus: number;
      totalDeadhead: number;
      efficiency: number;
    }

    // Chart data
    export interface ChartDataPoint {
      name: string;
      routes: number;
    }

    // Trend direction for indicators
    export type TrendDirection = 'up' | 'down' | 'neutral';
    ```

    These types are derived from the existing MapView.jsx metrics calculation and backend response structure.
  </action>
  <verify>
    Run `npx tsc --noEmit` from frontend directory - no type errors.
    File exists at frontend/src/types/metrics.ts with all 5 exports.
  </verify>
  <done>Types file exists with ScheduleItem, BusSchedule, Metrics, ChartDataPoint, TrendDirection exports</done>
</task>

<task type="auto">
  <name>Task 3: Create useMetrics hook</name>
  <files>frontend/src/hooks/useMetrics.ts</files>
  <action>
    Create `frontend/src/hooks/` directory if it doesn't exist.

    Create `frontend/src/hooks/useMetrics.ts`:

    ```typescript
    import { useMemo } from 'react';
    import type { BusSchedule, Metrics } from '../types/metrics';

    /**
     * Compute fleet metrics from schedule data.
     * Memoized for performance - only recalculates when schedule changes.
     */
    export function useMetrics(schedule: BusSchedule[] | null): Metrics | null {
      return useMemo(() => {
        if (!schedule || schedule.length === 0) return null;

        let totalRoutes = 0;
        let totalDeadhead = 0;
        let totalServiceTime = 0;

        const parseTime = (t: string): number => {
          if (!t) return 0;
          const [h, m] = t.split(':').map(Number);
          return h * 60 + m;
        };

        schedule.forEach(bus => {
          totalRoutes += bus.items.length;
          bus.items.forEach(item => {
            totalDeadhead += item.deadhead_minutes || 0;
            const start = parseTime(item.start_time);
            const end = parseTime(item.end_time);
            totalServiceTime += end - start;
          });
        });

        const avgRoutesPerBus = totalRoutes / schedule.length;
        const efficiency = totalServiceTime > 0
          ? (totalServiceTime / (totalServiceTime + totalDeadhead)) * 100
          : 0;

        return {
          totalBuses: schedule.length,
          totalRoutes,
          avgRoutesPerBus: Math.round(avgRoutesPerBus * 10) / 10,
          totalDeadhead,
          efficiency: Math.round(efficiency * 10) / 10,
        };
      }, [schedule]);
    }
    ```

    This is extracted from the existing MapView.jsx metrics calculation (lines 56-89) with TypeScript typing added.
  </action>
  <verify>
    Run `npx tsc --noEmit` from frontend directory - no type errors.
    File exists at frontend/src/hooks/useMetrics.ts with useMetrics export.
  </verify>
  <done>useMetrics hook exists, imports types correctly, exports useMetrics function</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd frontend && npm ls recharts` shows recharts@3.x
2. `npx tsc --noEmit` passes with no errors
3. `npm run build` completes successfully
4. Files exist:
   - frontend/src/types/metrics.ts
   - frontend/src/hooks/useMetrics.ts
</verification>

<success_criteria>
- Recharts 3.x installed in frontend/package.json
- types/metrics.ts exports ScheduleItem, BusSchedule, Metrics, ChartDataPoint, TrendDirection
- hooks/useMetrics.ts exports useMetrics function that accepts BusSchedule[] and returns Metrics
- TypeScript compilation passes
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-metrics-charts/02-01-SUMMARY.md`
</output>
