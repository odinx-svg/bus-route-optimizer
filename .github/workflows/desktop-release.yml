name: desktop-release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Validate desktop version matches git tag
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}".TrimStart("v")
          $content = Get-Content "scripts/desktop/desktop_version.py" -Raw
          if ($content -notmatch 'APP_VERSION\s*=\s*"([^"]+)"') {
            throw "APP_VERSION not found in scripts/desktop/desktop_version.py"
          }
          $fileVersion = $matches[1]
          if ($fileVersion -ne $tag) {
            throw "Version mismatch: tag=$tag but APP_VERSION=$fileVersion"
          }
          Write-Host "Desktop version validated: $fileVersion"

      - name: Validate updater/build contract guards
        shell: pwsh
        run: |
          $files = Get-ChildItem -Path "scripts/desktop" -Recurse -File
          $hits = $files | Select-String -Pattern "runtime-tmpdir" -SimpleMatch
          if ($hits) {
            $lines = ($hits | ForEach-Object { "$($_.Path):$($_.LineNumber):$($_.Line)" }) -join "`n"
            throw "Forbidden runtime-tmpdir usage detected:`n$lines"
          }
          Write-Host "No runtime-tmpdir references detected in desktop scripts."

      - name: Build desktop EXE + ZIP
        shell: cmd
        env:
          TUTTI_NON_INTERACTIVE: "1"
        run: scripts\desktop\build-desktop-app-exe.bat

      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup --no-progress -y

      - name: Build desktop installer
        shell: cmd
        env:
          TUTTI_NON_INTERACTIVE: "1"
        run: scripts\desktop\build-desktop-installer.bat

      - name: Smoke test desktop backend boot (onedir payload)
        shell: pwsh
        run: |
          $exe = "dist/desktop-app/installer-payload/Tutti Desktop.exe"
          if (-not (Test-Path $exe)) {
            throw "Smoke test executable missing: $exe"
          }

          $env:TUTTI_DESKTOP_DISABLE_AUTO_UPDATE = "1"
          $env:TUTTI_AFTER_UPDATE = "1"
          $proc = Start-Process -FilePath $exe -ArgumentList "--run-backend" -PassThru -WindowStyle Hidden
          try {
            $ok = $false
            for ($i = 0; $i -lt 60; $i++) {
              Start-Sleep -Seconds 1
              try {
                $health = Invoke-RestMethod -Uri "http://127.0.0.1:8000/health" -TimeoutSec 2
                if ($health.status -eq "ok") {
                  $ok = $true
                  break
                }
              } catch {
                # keep waiting
              }
            }
            if (-not $ok) {
              throw "Desktop smoke test failed: backend /health not ready in time."
            }
            Write-Host "Desktop smoke test passed."
          } finally {
            if ($proc -and -not $proc.HasExited) {
              Stop-Process -Id $proc.Id -Force
            }
            Get-Process -Name "Tutti Desktop" -ErrorAction SilentlyContinue | Stop-Process -Force
          }

      - name: Validate binaries do not contain hardcoded runtime temp path
        shell: pwsh
        run: |
          $targets = @(
            "dist/desktop-app/installer-payload/Tutti Desktop.exe",
            "dist/Tutti Desktop.exe"
          )
          $forbidden = @(
            [System.Text.Encoding]::ASCII.GetBytes("\Users\runneradmin\AppData\Local\TuttiRuntime"),
            [System.Text.Encoding]::ASCII.GetBytes("\AppData\Local\TuttiRuntime")
          )

          foreach ($target in $targets) {
            if (-not (Test-Path $target)) {
              throw "Missing binary for validation: $target"
            }
            $bytes = [System.IO.File]::ReadAllBytes($target)
            foreach ($needle in $forbidden) {
              $found = -1
              for ($i = 0; $i -le $bytes.Length - $needle.Length; $i++) {
                $ok = $true
                for ($j = 0; $j -lt $needle.Length; $j++) {
                  if ($bytes[$i + $j] -ne $needle[$j]) { $ok = $false; break }
                }
                if ($ok) { $found = $i; break }
              }
              if ($found -ge 0) {
                throw "Forbidden hardcoded runtime temp path found in $target at offset $found"
              }
            }
          }
          Write-Host "Binary runtime-temp path validation passed."

      - name: Generate SHA-256 checksums
        shell: pwsh
        run: |
          $checksumFile = "dist/desktop-app/checksums-sha256.txt"
          if (Test-Path $checksumFile) {
            Remove-Item $checksumFile -Force
          }
          $assets = @(
            "dist/desktop-app/TuttiSetup.exe",
            "dist/desktop-app/TuttiDesktopApp.zip"
          )
          foreach ($asset in $assets) {
            if (-not (Test-Path $asset)) {
              throw "Missing required asset: $asset"
            }
            $hash = (Get-FileHash -Path $asset -Algorithm SHA256).Hash.ToLower()
            $name = Split-Path $asset -Leaf
            "$hash  $name" | Out-File -Append -FilePath $checksumFile -Encoding utf8
            Write-Host "SHA-256 $name = $hash"
          }
          Write-Host "Checksum file:"
          Get-Content $checksumFile

      - name: Validate canonical release assets and checksums
        shell: pwsh
        run: |
          $required = @(
            "dist/desktop-app/TuttiSetup.exe",
            "dist/desktop-app/TuttiDesktopApp.zip",
            "dist/desktop-app/checksums-sha256.txt"
          )
          foreach ($path in $required) {
            if (-not (Test-Path $path)) {
              throw "Required release asset missing: $path"
            }
          }

          $checksums = Get-Content "dist/desktop-app/checksums-sha256.txt" -Raw
          foreach ($assetName in @("TuttiSetup.exe", "TuttiDesktopApp.zip")) {
            if ($checksums -notmatch [Regex]::Escape($assetName)) {
              throw "checksums-sha256.txt missing hash entry for $assetName"
            }
          }
          Write-Host "Canonical assets and checksums validated."

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: tutti-desktop-release
          path: |
            dist/desktop-app/TuttiSetup.exe
            dist/desktop-app/TuttiDesktopApp.zip
            dist/desktop-app/checksums-sha256.txt

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/desktop-app/TuttiSetup.exe
            dist/desktop-app/TuttiDesktopApp.zip
            dist/desktop-app/checksums-sha256.txt
          draft: false
          prerelease: false
          generate_release_notes: true
